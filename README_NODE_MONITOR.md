# èŠ‚ç‚¹çŠ¶æ€ç›‘æ§åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹çŠ¶æ€ç›‘æ§æœºåˆ¶ï¼Œèƒ½å¤Ÿåœ¨5ç§’å†…æ£€æµ‹åˆ°èŠ‚ç‚¹ç¦»çº¿å¹¶è§¦å‘ç›¸åº”æªæ–½ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **NodeStatusMonitor** - èŠ‚ç‚¹çŠ¶æ€ç›‘æ§å™¨
   - ç‹¬ç«‹çš„åå°çº¿ç¨‹ï¼Œæ¯ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰èŠ‚ç‚¹
   - è®¡ç®—èŠ‚ç‚¹æœ€åå¿ƒè·³æ—¶é—´ä¸å½“å‰æ—¶é—´çš„å·®è·
   - æ ¹æ®5ç§’é˜ˆå€¼åˆ¤æ–­èŠ‚ç‚¹åœ¨çº¿/ç¦»çº¿çŠ¶æ€

2. **AlarmManager** - å‘Šè­¦ç®¡ç†å™¨å¢å¼º
   - æ–°å¢ `calculateFingerprint()` æ–¹æ³•
   - æ–°å¢ `createOrUpdateAlarm()` æ–¹æ³•
   - æ–°å¢ `resolveAlarm()` æ–¹æ³•

3. **AlarmSystem** - ç³»ç»Ÿé›†æˆ
   - è‡ªåŠ¨åˆå§‹åŒ–å’Œå¯åŠ¨ NodeStatusMonitor
   - ä¼˜é›…å…³é—­æ—¶åœæ­¢ç›‘æ§å™¨

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. NodeStatusMonitor ç±»

**å¤´æ–‡ä»¶**: `include/resource/node_status_monitor.h`
**å®ç°æ–‡ä»¶**: `src/resource/node_status_monitor.cpp`

```cpp
class NodeStatusMonitor {
public:
    NodeStatusMonitor(std::shared_ptr<NodeStorage> node_storage, 
                     std::shared_ptr<AlarmManager> alarm_manager);
    void start();
    void stop();
    
private:
    void run();                    // åå°çº¿ç¨‹ä¸»å¾ªç¯
    void checkNodeStatus();        // æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
    
    std::shared_ptr<NodeStorage> m_node_storage;
    std::shared_ptr<AlarmManager> m_alarm_manager;
    std::atomic<bool> m_running;
    std::thread m_monitor_thread;
    
    const std::chrono::seconds m_check_interval{1};      // æ£€æŸ¥é—´éš”
    const std::chrono::seconds m_offline_threshold{5};   // ç¦»çº¿é˜ˆå€¼
};
```

### 2. å·¥ä½œæµç¨‹

```
1. è·å–æ‰€æœ‰èŠ‚ç‚¹åˆ—è¡¨ (NodeStorage::getAllNodes())
   â†“
2. éå†æ¯ä¸ªèŠ‚ç‚¹
   â†“
3. è®¡ç®—æ—¶é—´å·®: now - node->last_heartbeat
   â†“
4. åˆ¤æ–­çŠ¶æ€:
   â”œâ”€ æ—¶é—´å·® â‰¤ 5ç§’: èŠ‚ç‚¹åœ¨çº¿ â†’ è§£å†³ç›¸å…³å‘Šè­¦
   â””â”€ æ—¶é—´å·® > 5ç§’: èŠ‚ç‚¹ç¦»çº¿ â†’ åˆ›å»ºç¦»çº¿å‘Šè­¦
   â†“
5. ç­‰å¾…1ç§’åé‡å¤æ£€æŸ¥
```

### 3. å‘Šè­¦æœºåˆ¶

#### ç¦»çº¿å‘Šè­¦
- **å‘Šè­¦åç§°**: `NodeOffline`
- **å‘Šè­¦çº§åˆ«**: `critical`
- **è§¦å‘æ¡ä»¶**: èŠ‚ç‚¹è¶…è¿‡5ç§’æ— å¿ƒè·³
- **å‘Šè­¦å†…å®¹**: åŒ…å«èŠ‚ç‚¹IPã€ä¸»æœºåã€ç¦»çº¿æ—¶é•¿ç­‰ä¿¡æ¯

#### æ¢å¤å‘Šè­¦
- **çŠ¶æ€**: `resolved`
- **è§¦å‘æ¡ä»¶**: èŠ‚ç‚¹é‡æ–°å‘é€å¿ƒè·³
- **è‡ªåŠ¨è§£å†³**: ç³»ç»Ÿè‡ªåŠ¨è§£å†³ç›¸å…³å‘Šè­¦

### 4. å‘Šè­¦æŒ‡çº¹

æ¯ä¸ªèŠ‚ç‚¹çš„å‘Šè­¦éƒ½æœ‰å”¯ä¸€çš„æŒ‡çº¹æ ‡è¯†ï¼š
```
alertname=NodeOffline,host_ip=192.168.1.100,hostname=node-001
```

ç¡®ä¿ï¼š
- åŒä¸€èŠ‚ç‚¹çš„å¤šä¸ªå‘Šè­¦ä¸ä¼šé‡å¤
- ä¸åŒèŠ‚ç‚¹çš„å‘Šè­¦ç›¸äº’ç‹¬ç«‹
- å‘Šè­¦è§£å†³æ—¶èƒ½å‡†ç¡®æ‰¾åˆ°å¯¹åº”å‘Šè­¦

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨ä½¿ç”¨ï¼ˆæ¨èï¼‰

èŠ‚ç‚¹çŠ¶æ€ç›‘æ§å·²é›†æˆåˆ° `AlarmSystem` ä¸­ï¼Œç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ï¼š

```cpp
AlarmSystemConfig config;
// ... é…ç½®æ•°æ®åº“ç­‰å‚æ•°

AlarmSystem system(config);
system.initialize();  // è‡ªåŠ¨å¯åŠ¨èŠ‚ç‚¹çŠ¶æ€ç›‘æ§
```

### 2. æ‰‹åŠ¨ä½¿ç”¨

```cpp
auto node_storage = std::make_shared<NodeStorage>();
auto alarm_manager = std::make_shared<AlarmManager>(...);

auto monitor = std::make_shared<NodeStatusMonitor>(node_storage, alarm_manager);
monitor->start();

// ... ç³»ç»Ÿè¿è¡Œ ...

monitor->stop();
```

## ğŸ“Š API æ¥å£

### è·å–èŠ‚ç‚¹åˆ—è¡¨
```bash
GET /api/v1/nodes/list
```

å“åº”ä¸­çš„èŠ‚ç‚¹çŠ¶æ€æ˜¯åŠ¨æ€è®¡ç®—çš„ï¼š
```json
{
  "status": "success",
  "data": [
    {
      "api_version": "v1",
      "data": {
        "box_id": "node-001",
        "host_ip": "192.168.1.100",
        "hostname": "node-001",
        "status": "online"  // åŠ¨æ€è®¡ç®—çš„çŠ¶æ€
      }
    }
  ]
}
```

### è·å–å‘Šè­¦äº‹ä»¶
```bash
GET /api/v1/alarm/events
```

å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹ç¦»çº¿å‘Šè­¦ï¼š
```json
{
  "status": "success",
  "data": {
    "events": [
      {
        "fingerprint": "alertname=NodeOffline,host_ip=192.168.1.100",
        "status": "firing",
        "labels": {
          "alert_name": "NodeOffline",
          "host_ip": "192.168.1.100",
          "severity": "critical"
        },
        "annotations": {
          "summary": "Node is offline",
          "description": "Node 192.168.1.100 has not sent a heartbeat for more than 5 seconds."
        }
      }
    ]
  }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•è„šæœ¬
```bash
./scripts/test_node_monitor.sh
```

### 2. æ‰‹åŠ¨æµ‹è¯•
```bash
# å¯åŠ¨ç³»ç»Ÿ
./MyProject &

# å‘é€å¿ƒè·³
curl -X POST http://localhost:8080/heartbeat \
  -H "Content-Type: application/json" \
  -d '{"api_version": "v1", "data": {...}}'

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
curl http://localhost:8080/api/v1/nodes/list

# ç­‰å¾…5ç§’åæ£€æŸ¥å‘Šè­¦
curl http://localhost:8080/api/v1/alarm/events
```

### 3. æ¼”ç¤ºç¨‹åº
```bash
# ç¼–è¯‘æ¼”ç¤ºç¨‹åº
g++ -std=c++14 -Iinclude examples/node_monitor_demo.cpp -o node_monitor_demo

# è¿è¡Œæ¼”ç¤º
./node_monitor_demo
```

## ğŸ“ˆ æ€§èƒ½ç‰¹ç‚¹

### 1. è½»é‡çº§è®¾è®¡
- **æ£€æŸ¥é¢‘ç‡**: æ¯ç§’ä¸€æ¬¡ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
- **å†…å­˜ä½¿ç”¨**: åªå­˜å‚¨èŠ‚ç‚¹å¼•ç”¨ï¼Œä¸å¤åˆ¶æ•°æ®
- **CPU ä½¿ç”¨**: è½»é‡çº§æ£€æŸ¥ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å¾ˆå°

### 2. é«˜æ•ˆå‘Šè­¦
- **æ•°æ®åº“è´Ÿè½½**: åªåœ¨çŠ¶æ€å˜åŒ–æ—¶å†™å…¥æ•°æ®åº“
- **å‘Šè­¦å»é‡**: ä½¿ç”¨æŒ‡çº¹æœºåˆ¶é¿å…é‡å¤å‘Šè­¦
- **è‡ªåŠ¨æ¢å¤**: èŠ‚ç‚¹æ¢å¤æ—¶è‡ªåŠ¨è§£å†³å‘Šè­¦

### 3. å¯æ‰©å±•æ€§
- **é…ç½®çµæ´»**: æ£€æŸ¥é—´éš”å’Œç¦»çº¿é˜ˆå€¼å¯é…ç½®
- **æ¨¡å—åŒ–è®¾è®¡**: å¯ç‹¬ç«‹ä½¿ç”¨æˆ–é›†æˆåˆ°å…¶ä»–ç³»ç»Ÿ
- **æ¥å£æ ‡å‡†åŒ–**: ä½¿ç”¨æ ‡å‡†å‘Šè­¦äº‹ä»¶æ ¼å¼

## ğŸ”§ é…ç½®é€‰é¡¹

### ä¿®æ”¹æ£€æŸ¥é—´éš”
```cpp
// åœ¨ NodeStatusMonitor æ„é€ å‡½æ•°ä¸­ä¿®æ”¹
const std::chrono::seconds m_check_interval{1}; // æ¯ç§’æ£€æŸ¥
```

### ä¿®æ”¹ç¦»çº¿é˜ˆå€¼
```cpp
// åœ¨ NodeStatusMonitor æ„é€ å‡½æ•°ä¸­ä¿®æ”¹
const std::chrono::seconds m_offline_threshold{5}; // 5ç§’æ— å¿ƒè·³è®¤ä¸ºç¦»çº¿
```

## ğŸ“ æ—¥å¿—è¾“å‡º

### å¯åŠ¨æ—¥å¿—
```
ğŸ‘ï¸ åˆå§‹åŒ–èŠ‚ç‚¹çŠ¶æ€ç›‘æ§å™¨...
âœ… èŠ‚ç‚¹çŠ¶æ€ç›‘æ§å™¨å¯åŠ¨æˆåŠŸ
```

### ç›‘æ§æ—¥å¿—
```
Node '192.168.1.100' is offline. Last heartbeat 6 seconds ago.
```

### å‘Šè­¦æ—¥å¿—
```
AlarmManager: Processing alarm event: alertname=NodeOffline,host_ip=192.168.1.100 - firing
AlarmManager: Alarm event inserted successfully: alertname=NodeOffline,host_ip=192.168.1.100
```

## ğŸ¯ åŠŸèƒ½éªŒè¯

### âœ… å·²å®ç°åŠŸèƒ½

1. **ä¸»åŠ¨ç›‘æ§**: âœ… æ¯ç§’æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
2. **ç¦»çº¿æ£€æµ‹**: âœ… 5ç§’æ— å¿ƒè·³è‡ªåŠ¨æ£€æµ‹ç¦»çº¿
3. **å‘Šè­¦è§¦å‘**: âœ… èŠ‚ç‚¹ç¦»çº¿æ—¶è‡ªåŠ¨åˆ›å»ºå‘Šè­¦
4. **è‡ªåŠ¨æ¢å¤**: âœ… èŠ‚ç‚¹æ¢å¤æ—¶è‡ªåŠ¨è§£å†³å‘Šè­¦
5. **å”¯ä¸€æ ‡è¯†**: âœ… æ¯ä¸ªèŠ‚ç‚¹å‘Šè­¦æœ‰å”¯ä¸€æŒ‡çº¹
6. **ç³»ç»Ÿé›†æˆ**: âœ… å·²é›†æˆåˆ° AlarmSystem ä¸­
7. **ä¼˜é›…å…³é—­**: âœ… ç³»ç»Ÿå…³é—­æ—¶åœæ­¢ç›‘æ§å™¨

### ğŸ”® æ‰©å±•åŠŸèƒ½ï¼ˆæœªæ¥è®¡åˆ’ï¼‰

1. **å¯é…ç½®é˜ˆå€¼**: æ”¯æŒä¸åŒèŠ‚ç‚¹ç±»å‹çš„ä¸åŒç¦»çº¿é˜ˆå€¼
2. **å‘Šè­¦æŠ‘åˆ¶**: æ”¯æŒå‘Šè­¦æŠ‘åˆ¶å’Œé™é»˜åŠŸèƒ½
3. **é€šçŸ¥é›†æˆ**: é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ç­‰é€šçŸ¥æ–¹å¼
4. **å†å²è®°å½•**: è®°å½•èŠ‚ç‚¹çŠ¶æ€å˜åŒ–å†å²
5. **å¥åº·æ£€æŸ¥**: æ”¯æŒè‡ªå®šä¹‰å¥åº·æ£€æŸ¥è§„åˆ™

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [èŠ‚ç‚¹çŠ¶æ€ç›‘æ§è¯¦ç»†æ–‡æ¡£](docs/node_status_monitor.md)
- [å‘Šè­¦ç³»ç»Ÿæ¶æ„æ–‡æ¡£](docs/alarm.md)
- [API æ¥å£æ–‡æ¡£](docs/apiv1.md)

## ğŸ‰ æ€»ç»“

æˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹çŠ¶æ€ç›‘æ§ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **å®æ—¶æ€§**: æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œ5ç§’å†…æ£€æµ‹åˆ°ç¦»çº¿
2. **å¯é æ€§**: ä½¿ç”¨æŒ‡çº¹æœºåˆ¶ç¡®ä¿å‘Šè­¦å‡†ç¡®æ€§
3. **è‡ªåŠ¨åŒ–**: æ— éœ€äººå·¥å¹²é¢„ï¼Œè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤
4. **é›†æˆæ€§**: å®Œç¾é›†æˆåˆ°ç°æœ‰å‘Šè­¦ç³»ç»Ÿä¸­
5. **å¯æ‰©å±•æ€§**: æ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

è¯¥ç³»ç»Ÿèƒ½å¤Ÿæœ‰æ•ˆç›‘æ§é›†ç¾¤ä¸­èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†èŠ‚ç‚¹ç¦»çº¿é—®é¢˜ï¼Œä¸ºç³»ç»Ÿè¿ç»´æä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æŒã€‚ 